要做大型分布式系统设计，最重要的事情是：把你所做的事情清楚、准确的描述出来。通常在进行大型分布式系统设计的时候都要进行design review，这个过程需要保证你的设计和别人理解你的设计尽量少的出现偏差。笔者参与或主导设计过三个大型的模块：

1. DAL(Data Access Layer)。该系统封装数据库的结构，解耦数据库和服务模块。
2. 离线数据更新系统。把离线算法模型更新到线上，供线上服务使用，实现数据版本化、回滚和监控。
3. 广告索引系统。该系统实现广告数据的增量更新和广告定向信息索引更新（正在参与设计中）

就这些模块总结一些设计系统的方法论和套路。

# 模板

高考写作文的时候，老师都非常讨厌模板，但是我这里还是推荐按照固定的套路，这样可以方便的讲清楚问题。

* 简介（描述为什么做，解决什么问题）

  * 背景。面临的问题是什么，使用该系统后会变成什么样子。
  * Goal。进度和人日预估，版本功能点和时间节点。
  * 术语。该系统中特有的词汇，但是不要把大家认为common sence的东西写进去。
  * 参考资料
* 总体设计

  * 规约。描述好该系统解决问题的边界是什么？可以承载多大的并发，多少数据，数据更新频率。
  * 系统结构图(系统间)。该系统和其他系统的交互关系。
  * 模块图(系统内)。该系统分为几个模块，同时要给出：图例、数据流向、数据模块、功能模块。
* 功能模块1。

  * 功能描述。描述好功能、每个功能点面向谁、交互的模块是什么、数据流向。
  * API定义。描述好API的功能、同步还是异步、阻塞还是非阻塞。
  * 关键点。如果涉及到分布式锁、一致性等对于该模块比较重要的点需要单独说一下。
  * 示意图。如果面向的是用户，可以适当给出示意图。
  * 可用性。
* 功能模块X
* 数据模块1。

  * 表设计。需要详细描述数据库表，包括字段的类型、含义、更新频率等信息。
  * 数据一致性保证、完整性。
* 数据模块X。
* 关键流程(功能)说明
  * 该模块用于主要的功能点说明。比如你设计的是外卖订单系统，那么下单，退单，结算等就显得尤为重要。
  * 这个部分可能需要画泳道图、或者跨职能流程图，角色就是上面定义的各模块。
  * 异常。如果关键步骤失败了，会出现什么情况，系统对该情况的容忍度。


* 可用性说明
  * 如果某个模块挂掉，或者该系统的某个子系统挂掉会出现什么情况，需要详细给出系统的可用性并有后续的action跟踪。


* 监控报警集成
  * 需要集成哪些监控项和报警项。


* 环境要求
  * 描述JDK、ZK、thrift、dubbo、mysql等。如果部门都是统一的，该章节可以省略。




当然，以上的只是给出一个套路，具体看系统的侧重点，每个系统对外部服务可用性、基础服务可用性的依赖都是不一样的。本文提供一个基本的框架，这样做design的时候会比较有条理。

# IDEA

可以看到，要想准确无误的传达信息，最重要的两个图：**系统结构图(系统间)和模块图(系统内)**。这两个图直接决定了你整个design的走向，是做成一个服务还是做成一个jar包，是同步还是异步等等。 如果拿捏不定，需要自己列出类似于决策平衡单的东西。

| 对比项   | 方案1  | 方案2  | 方案3  |
| ----- | ---- | ---- | :--- |
| 系统结构图 |      |      |      |
| 模块框图  |      |      |      |
| 优点    |      |      |      |
| 缺点    |      |      |      |

该图列出后，系统设计主笔者需要给出推荐理由，并做一些取舍，作为设计初稿可以给组内review或者组织brain storm ，最终拍板形成最终设计方案。刚毕业的同学这个部分很难，通常需要自己调研业界已有方案，和自己的业务痛点和场景做对比，然后提出上面的对比方案，组织一个brain storm，把大家的的idea记下来之后，会有新的idea。

# Diss 自己

自己设计的系统就是要不断的和自己的idea做斗争，最终得出一个相对优化或者折中的设计。要把自己想象成被challenge的对象，在做一个系统的时候怎么去challenge自己呢?尤其是在没有经验的时候，自己想的时候觉得自己很完美，结果别人挑出一堆毛病没办法解决。我自己总结了一些常规的点如下：

* 系统或者子系统挂掉。任意一个节点挂掉系统的可用性，自己随便想想挂掉个几个模块，宕机几台机子。
* 数据的一致性。
* 不同节点之间会不会存在竞争共享锁。
* 数据的完整性。
* 系统调用超时。
* 该系统发生状态变化时候，对线上系统其他系统的影响。
* 如果是服务，什么时候需要熔断，什么时候进行服务降级。
* 用户异常行为。
* 技术实现难度。这个需要自己对细节和不可控部分有认识，不然很容易画大饼，避免的办法是多交流。
* 启动速度，回滚速度，响应速度。
* 什么时候触发监控，报警频率和量级会不会对其他系统构成挑战。
* 进度预估是否合理。
* 数据库容量会不会爆炸增长，尤其是异常的时候。
* 系统瓶颈在哪里。比如索引系统的瓶颈在于更新索引，状态是否一致。
* 系统迭代更新时可用性。
* 系统的边界界定是否合理。比如该系统解决的问题是不是还可以扩大一点，涵盖的业务是不是可以更多。
* 是不是可以复用已有模块避免重复造轮子。

Diss自己还需要整个复盘交互的细节，通常会发现很多问题自己没有考虑到。

# 细节

通常Diss完自己后，根据别人的意见修改，还需要check一下一些细节，这个部分很多人不注意。

* 图例。图例其实很有用，尤其是系统稍微复杂一点。比如：数据模块、中间件、功能模块、元数据流、主数据流。不写图例让人觉得很混乱。
* 数据规约的大小是不是合适。比如你随便定一个只支持500M的数据更新，有没有数据支持。
* 模块颜色。通常系统设计都需要分层，尽量用不同颜色标志，如接入层、转发层、业务层、数据层等。但是颜色不要太浮夸，毕竟程序员是需要低调一点的。

![哈工大校训](如何做好的design/HIT.jpg)

